# 海康威视摄像头集成指南

## 一、集成方式概述

海康威视摄像头支持多种集成方式，根据项目需求推荐使用以下方案：

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **RTSP协议** | 通用性强、实现简单 | 延迟略高(1-3秒) | 通用监控、AI分析 |
| **海康SDK** | 功能丰富、低延迟 | 需要海康库、平台依赖 | 专业部署 |
| **ISAPI接口** | HTTP调用、易集成 | 功能有限 | 简单场景 |
| **GB28181** | 国标协议、兼容性好 | 配置复杂 | 大规模平台 |

### 推荐方案

**本项目采用 RTSP + 海康SDK 混合方案**：
- 主流程使用RTSP（兼容性好，便于开发测试）
- 高级功能使用SDK（PTZ控制、事件订阅等）

## 二、RTSP流地址格式

### 海康威视RTSP URL格式

```
rtsp://[用户名]:[密码]@[IP地址]:[端口]/[编码通道]/[码流类型]/av_stream

示例：
# 主码流（高清）
rtsp://admin:password123@192.168.1.64:554/Streaming/Channels/101/av_stream

# 子码流（流畅）
rtsp://admin:password123@192.168.1.64:554/Streaming/Channels/102/av_stream

# 第三码流（低码率）
rtsp://admin:password123@192.168.1.64:554/Streaming/Channels/103/av_stream
```

### 通道编号说明

| 通道号 | 含义 |
|--------|------|
| 101 | 通道1主码流 |
| 102 | 通道1子码流 |
| 201 | 通道2主码流 |
| 202 | 通道2子码流 |

### 其他格式

```bash
# 老版本格式
rtsp://admin:password@192.168.1.64:554/h264/ch1/main/av_stream
rtsp://admin:password@192.168.1.64:554/h264/ch1/sub/av_stream

# ONVIF格式
rtsp://admin:password@192.168.1.64:554/onvif1
```

## 三、摄像头配置要求

### 3.1 分辨率设置

| 用途 | 推荐分辨率 | 帧率 | 码流 |
|------|-----------|------|------|
| AI分析 | 1920×1080 | 25fps | 4-6Mbps |
| 录像存储 | 1280×720 | 15fps | 2-3Mbps |
| 预览显示 | 704×576 | 15fps | 1Mbps |

### 3.2 编码设置

- **视频编码**：H.264（兼容性好）或 H.265（带宽节省50%）
- **编码复杂度**：中等
- **I帧间隔**：50帧（2秒一个关键帧）
- **码率类型**：变码率（VBR）

### 3.3 网络设置

```
摄像头IP：192.168.1.64-192.168.1.213（150台）
子网掩码：255.255.255.0
网关：192.168.1.1
RTSP端口：554
HTTP端口：80
```

## 四、Python集成代码示例

### 4.1 安装依赖

```bash
pip install opencv-python
pip install opencv-python-headless  # 服务器环境
pip install ffmpeg-python
```

### 4.2 基础连接测试

```python
import cv2

# 海康威视RTSP地址
rtsp_url = "rtsp://admin:password@192.168.1.64:554/Streaming/Channels/101"

# 打开视频流
cap = cv2.VideoCapture(rtsp_url, cv2.CAP_FFMPEG)

# 设置缓冲区大小（减少延迟）
cap.set(cv2.CAP_PROP_BUFFERSIZE, 1)

if cap.isOpened():
    print("✅ 连接成功")
    ret, frame = cap.read()
    if ret:
        print(f"分辨率: {frame.shape[1]}x{frame.shape[0]}")
else:
    print("❌ 连接失败")

cap.release()
```

### 4.3 常见问题

**问题1：连接超时**
```python
# 添加超时参数
cap = cv2.VideoCapture(rtsp_url)
cap.set(cv2.CAP_PROP_OPEN_TIMEOUT_MSEC, 5000)
```

**问题2：画面延迟大**
```python
# 使用FFmpeg后端，降低缓冲
import os
os.environ["OPENCV_FFMPEG_CAPTURE_OPTIONS"] = "rtsp_transport;udp"
```

**问题3：频繁断开**
```python
# 实现自动重连机制
# 见完整代码
```

## 五、部署架构

### 网络拓扑

```
                    ┌─────────────────┐
                    │   AI服务器      │
                    │  (GPU处理)      │
                    └────────┬────────┘
                             │ 万兆
                    ┌────────┴────────┐
                    │   核心交换机     │
                    │   (万兆)        │
                    └────────┬────────┘
            ┌────────────────┼────────────────┐
            │                │                │
    ┌───────┴───────┐ ┌─────┴─────┐ ┌───────┴───────┐
    │  接入交换机-1  │ │ 接入交换机-2│ │  接入交换机-3  │
    │   (千兆PoE)   │ │  (千兆PoE) │ │   (千兆PoE)   │
    └───────┬───────┘ └─────┬─────┘ └───────┬───────┘
            │               │               │
    ┌───────┴───────┐       │       ┌───────┴───────┐
    │  工位1-20     │       │       │   工位41-50   │
    │  (60台摄像头) │       │       │  (30台摄像头) │
    └───────────────┘       │       └───────────────┘
                    ┌───────┴───────┐
                    │   工位21-40   │
                    │  (60台摄像头) │
                    └───────────────┘
```

### 硬件清单

| 设备 | 型号推荐 | 数量 | 单价 | 总价 |
|------|---------|------|------|------|
| 摄像头 | DS-2CD3T47WD-L | 150台 | ¥600 | ¥90,000 |
| PoE交换机 | DS-3E1528P-SI | 8台 | ¥3,000 | ¥24,000 |
| 核心交换机 | DS-3E3730 | 1台 | ¥15,000 | ¥15,000 |
| AI服务器 | GPU服务器 | 1台 | ¥80,000 | ¥80,000 |
| **合计** | | | | **¥209,000** |

## 六、调试工具

### 6.1 VLC测试

```bash
vlc rtsp://admin:password@192.168.1.64:554/Streaming/Channels/101
```

### 6.2 FFmpeg测试

```bash
# 测试连接
ffprobe rtsp://admin:password@192.168.1.64:554/Streaming/Channels/101

# 截图测试
ffmpeg -i rtsp://admin:password@192.168.1.64:554/Streaming/Channels/101 -frames:v 1 test.jpg

# 录制测试
ffmpeg -i rtsp://admin:password@192.168.1.64:554/Streaming/Channels/101 -t 10 -c copy test.mp4
```

### 6.3 海康威视SADP工具

下载地址：https://www.hikvision.com/cn/support/tools/

功能：
- 批量搜索设备
- 修改IP地址
- 激活摄像头
- 重置密码

