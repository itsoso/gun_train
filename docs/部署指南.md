# 智能枪械训练系统 - 部署指南

## 一、环境准备

### 1.1 硬件要求

#### 服务器配置
- **CPU**: Intel Xeon 或同等性能（≥16核）
- **GPU**: NVIDIA Tesla T4 或更高（用于AI推理）
- **内存**: ≥64GB DDR4
- **存储**: 2TB NVMe SSD + 10TB HDD
- **网络**: 万兆网卡

#### 摄像头配置
- **型号**: 1080P工业摄像头
- **协议**: RTSP
- **数量**: 每工位3个（正面、侧面、俯视）
- **供电**: PoE供电

### 1.2 软件环境

#### 操作系统
- Ubuntu 20.04 LTS 或更高版本
- CentOS 8 或更高版本

#### 依赖软件
```bash
# Python 3.9+
sudo apt update
sudo apt install python3.9 python3.9-venv python3-pip

# PostgreSQL 13+
sudo apt install postgresql postgresql-contrib

# MongoDB 5.0+
wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-5.0.list
sudo apt update
sudo apt install -y mongodb-org

# Redis 6.0+
sudo apt install redis-server

# FFmpeg
sudo apt install ffmpeg

# NVIDIA驱动和CUDA（用于GPU加速）
# 参考 https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html
```

## 二、系统安装

### 2.1 克隆项目

```bash
cd /opt
git clone https://github.com/your-org/gun_train.git
cd gun_train
```

### 2.2 运行安装脚本

```bash
chmod +x scripts/setup.sh
./scripts/setup.sh
```

### 2.3 配置环境变量

编辑 `.env` 文件：

```bash
nano .env
```

配置数据库连接和其他参数：

```ini
# 数据库配置
DATABASE_URL=postgresql://gun_admin:your_password@localhost:5432/gun_training
MONGODB_URL=mongodb://localhost:27017
REDIS_URL=redis://localhost:6379/0

# API配置
API_HOST=0.0.0.0
API_PORT=8000

# JWT密钥（请修改为随机字符串）
SECRET_KEY=$(openssl rand -hex 32)
```

### 2.4 初始化数据库

```bash
# 激活虚拟环境
source venv/bin/activate

# 创建数据库
sudo -u postgres psql -c "CREATE DATABASE gun_training;"
sudo -u postgres psql -c "CREATE USER gun_admin WITH PASSWORD 'your_password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE gun_training TO gun_admin;"

# 初始化表结构
python -m backend.db.database
```

### 2.5 导入初始数据

```bash
# 创建管理员用户
python scripts/create_admin.py
```

## 三、AI模型部署

### 3.1 姿态识别模型

MediaPipe模型会自动下载，无需手动配置。

### 3.2 枪支检测模型

需要训练YOLOv8模型：

```bash
# 1. 准备训练数据（将标注好的数据放在 data/gun_detection/）
# 2. 训练模型
python scripts/train_gun_detector.py

# 3. 模型会自动保存到 models/gun_detection_yolov8.pt
```

### 3.3 动作分析模型

```bash
# 训练动作规范性判定模型
python scripts/train_action_analyzer.py
```

## 四、系统启动

### 4.1 使用systemd管理服务

#### 创建API服务

```bash
sudo nano /etc/systemd/system/gun-train-api.service
```

内容：

```ini
[Unit]
Description=Gun Training System API
After=network.target postgresql.service mongodb.service redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/gun_train
Environment="PATH=/opt/gun_train/venv/bin"
ExecStart=/opt/gun_train/venv/bin/uvicorn backend.api.main:app --host 0.0.0.0 --port 8000
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 创建Celery后台任务服务

```bash
sudo nano /etc/systemd/system/gun-train-worker.service
```

内容：

```ini
[Unit]
Description=Gun Training System Worker
After=network.target redis.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/gun_train
Environment="PATH=/opt/gun_train/venv/bin"
ExecStart=/opt/gun_train/venv/bin/celery -A backend.tasks worker --loglevel=info
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable gun-train-api
sudo systemctl enable gun-train-worker
sudo systemctl start gun-train-api
sudo systemctl start gun-train-worker

# 查看状态
sudo systemctl status gun-train-api
sudo systemctl status gun-train-worker
```

### 4.2 配置Nginx反向代理

```bash
sudo nano /etc/nginx/sites-available/gun-train
```

内容：

```nginx
server {
    listen 80;
    server_name gun-train.local;

    # API代理
    location /api {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # WebSocket代理
    location /ws {
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    # 前端静态文件
    location / {
        root /opt/gun_train/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/gun-train /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 五、摄像头配置

### 5.1 配置RTSP流

在 `backend/config/cameras.yaml` 中配置摄像头：

```yaml
cameras:
  - camera_id: 1
    workstation_id: 1
    view_angle: front
    rtsp_url: rtsp://192.168.1.101:554/stream
    enabled: true

  - camera_id: 2
    workstation_id: 1
    view_angle: side
    rtsp_url: rtsp://192.168.1.102:554/stream
    enabled: true

  - camera_id: 3
    workstation_id: 1
    view_angle: top
    rtsp_url: rtsp://192.168.1.103:554/stream
    enabled: true

  # ... 其他工位的摄像头配置
```

### 5.2 测试摄像头连接

```bash
# 测试单个摄像头
ffplay rtsp://192.168.1.101:554/stream

# 批量测试
python scripts/test_cameras.py
```

## 六、系统测试

### 6.1 健康检查

```bash
# API健康检查
curl http://localhost:8000/health

# 数据库连接测试
python -m backend.db.database
```

### 6.2 功能测试

```bash
# 运行单元测试
pytest tests/

# 运行集成测试
pytest tests/integration/
```

### 6.3 性能测试

```bash
# 压力测试
locust -f tests/load_test.py --host http://localhost:8000
```

## 七、监控和日志

### 7.1 日志配置

日志文件位置：
- API日志: `/opt/gun_train/logs/api.log`
- Worker日志: `/opt/gun_train/logs/worker.log`
- Nginx日志: `/var/log/nginx/access.log`

### 7.2 监控配置

使用Prometheus + Grafana监控系统：

```bash
# 安装Prometheus
# 参考 https://prometheus.io/docs/prometheus/latest/installation/

# 配置监控端点
# API会自动暴露 /metrics 端点
```

### 7.3 告警配置

配置邮件/短信告警：

```yaml
# backend/config/alerts.yaml
alerts:
  - type: critical_warning
    threshold: 5  # 5分钟内超过5次严重预警
    notification:
      - email: admin@example.com
      - sms: 138xxxxxxxx
```

## 八、备份和恢复

### 8.1 数据库备份

```bash
# PostgreSQL备份
pg_dump -U gun_admin gun_training > backup_$(date +%Y%m%d).sql

# MongoDB备份
mongodump --db gun_training_videos --out backup_mongo_$(date +%Y%m%d)
```

### 8.2 视频备份

```bash
# 备份录像文件
rsync -av /var/gun_train/videos/ /backup/videos/
```

### 8.3 自动备份脚本

```bash
# 添加到crontab
crontab -e

# 每天凌晨2点备份
0 2 * * * /opt/gun_train/scripts/backup.sh
```

## 九、安全加固

### 9.1 防火墙配置

```bash
# 只开放必要端口
sudo ufw enable
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 22/tcp    # SSH（仅内网）
```

### 9.2 数据加密

- 数据库连接使用SSL
- API使用HTTPS（配置SSL证书）
- 视频传输使用加密RTSP

### 9.3 访问控制

- 实施基于角色的访问控制（RBAC）
- 所有API请求需要JWT认证
- 定期更新密码和密钥

## 十、故障排查

### 10.1 常见问题

#### API无法启动
```bash
# 检查端口占用
sudo netstat -tlnp | grep 8000

# 查看日志
tail -f logs/api.log
```

#### 摄像头连接失败
```bash
# 测试网络连通性
ping 192.168.1.101

# 测试RTSP流
ffmpeg -i rtsp://192.168.1.101:554/stream -t 10 test.mp4
```

#### GPU不可用
```bash
# 检查GPU状态
nvidia-smi

# 检查CUDA
python -c "import torch; print(torch.cuda.is_available())"
```

### 10.2 性能优化

#### GPU利用率低
- 增加batch size
- 使用TensorRT加速推理

#### 内存占用过高
- 调整视频处理帧率
- 减少历史数据保留时间

#### 数据库查询慢
- 添加索引
- 使用Redis缓存

## 十一、技术支持

如遇到问题，请联系：
- 技术支持邮箱: support@example.com
- 技术支持电话: 400-xxx-xxxx
- 在线文档: https://docs.example.com

## 十二、更新和升级

### 12.1 系统更新

```bash
cd /opt/gun_train
git pull origin main

# 更新依赖
source venv/bin/activate
pip install -r requirements.txt --upgrade

# 重启服务
sudo systemctl restart gun-train-api
sudo systemctl restart gun-train-worker
```

### 12.2 数据库迁移

```bash
# 使用Alembic进行数据库迁移
alembic upgrade head
```

